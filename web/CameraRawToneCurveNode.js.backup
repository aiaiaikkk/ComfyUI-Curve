import { app } from "../../scripts/app.js";

<<<<<<< HEAD
=======
/*
 * CameraRawToneCurveNode.js - Camera Raw Tone Curve Node
 * 
 * Features:
 * 1. Fully aligned with Adobe Camera Raw tone curves
 * 2. Supports Point Curve and Parametric Curve
 * 3. Built-in Linear/Medium Contrast/Strong Contrast presets
 * 4. Real-time preview functionality
 * 5. Four region adjustments: Highlights, Lights, Darks, Shadows
 */

// Global node output cache
if (!window.globalNodeCache) {
    window.globalNodeCache = new Map();
}

// Setup global node output cache
function setupGlobalNodeOutputCache() {
    if (app.api) {
        app.api.addEventListener("executed", ({ detail }) => {
            const nodeId = String(detail.node);
            const outputData = detail.output;
            
            if (nodeId && outputData && outputData.images) {
                window.globalNodeCache.set(nodeId, outputData);
                
                if (!app.nodeOutputs) {
                    app.nodeOutputs = {};
                }
                app.nodeOutputs[nodeId] = outputData;
                
                const node = app.graph.getNodeById(nodeId);
                if (node && outputData.images && outputData.images.length > 0) {
                    const convertToImageUrl = (imageData) => {
                        if (typeof imageData === 'string') {
                            return imageData;
                        }
                        if (imageData && typeof imageData === 'object' && imageData.filename) {
                            const baseUrl = window.location.origin;
                            let url = `${baseUrl}/view?filename=${encodeURIComponent(imageData.filename)}`;
                            if (imageData.subfolder) {
                                url += `&subfolder=${encodeURIComponent(imageData.subfolder)}`;
                            }
                            if (imageData.type) {
                                url += `&type=${encodeURIComponent(imageData.type)}`;
                            }
                            return url;
                        }
                        return null;
                    };
                    
                    const imageUrls = outputData.images.map(convertToImageUrl).filter(url => url !== null);
                    
                    if (!node.imgs) {
                        node.imgs = [];
                    }
                    node.imgs = imageUrls;
                }
            }
        });
    }
}

// Setup cache when page loads
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', setupGlobalNodeOutputCache);
} else {
    setupGlobalNodeOutputCache();
}

>>>>>>> 46f66396712d9c95a0a726341177cdf1f4149a5f
app.registerExtension({
    name: "CameraRawToneCurveNode",
    async beforeRegisterNodeDef(nodeType, nodeData, app) {
        if (nodeData.name === "CameraRawToneCurveNode") {
            const onNodeCreated = nodeType.prototype.onNodeCreated;
            
            nodeType.prototype.onNodeCreated = function () {
                const result = onNodeCreated ? onNodeCreated.apply(this, arguments) : undefined;
                
                // Add double-click popup functionality
                this.onDblClick = () => {
                    this.showToneCurveModal();
                    return true;
                };
                
                // Initialize node data
                this.toneCurveData = {
                    curve_preset: 'Linear',
                    point_curve: '[[0,0],[255,255]]',
                    highlights: 0.0,
                    lights: 0.0,
                    darks: 0.0,
                    shadows: 0.0,
                    curve_mode: 'Combined'
                };
                
<<<<<<< HEAD
                // Initialize image processing related properties
                this.currentImage = null;
                this.previewCanvas = null;
                this.previewContext = null;
                this.isImageLoaded = false;
                this.preventInvalidDraw = true;
                
=======
>>>>>>> 46f66396712d9c95a0a726341177cdf1f4149a5f
                return result;
            };
            
            // Add tone curve popup method
            nodeType.prototype.showToneCurveModal = function() {
                this.createToneCurveModal();
            };
            
            nodeType.prototype.createToneCurveModal = function() {
                // ç§»é™¤ç°æœ‰å¼¹çª—
                const existingModal = document.getElementById('toneCurveModal');
                if (existingModal) {
                    existingModal.remove();
                }
                
                // åˆ›å»ºå¼¹çª—
                const modal = document.createElement('div');
                modal.id = 'toneCurveModal';
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background-color: rgba(0, 0, 0, 0.8);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    z-index: 10000;
                `;
                
                const content = document.createElement('div');
                content.style.cssText = `
<<<<<<< HEAD
                    background: #1e1e1e;
                    border-radius: 8px;
                    border: 1px solid #333;
                    overflow: hidden;
                    padding: 0;
                    max-width: 90vw;
                    max-height: 90vh;
                    width: 1200px;
                    height: 800px;
                    display: flex;
                    flex-direction: column;
                    color: #fff;
                    font-family: Arial, sans-serif;
                `;
                
                // åˆ›å»ºæ ‡é¢˜æ 
                const header = document.createElement('div');
                header.style.cssText = `
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    padding: 10px 20px;
                    background: #2a2a2a;
                    border-bottom: 1px solid #333;
                `;
                
                const title = document.createElement('div');
                title.style.cssText = `
                    font-size: 16px;
                    font-weight: bold;
                    color: #fff;
                `;
                title.textContent = 'ğŸ“ˆ Camera Raw è‰²è°ƒæ›²çº¿';
                
                // é¢„è®¾æ§ä»¶
                const presetContainer = document.createElement('div');
                presetContainer.style.cssText = `
                    display: flex;
                    gap: 10px;
                    align-items: center;
                `;
                
                const presetSelect = document.createElement('select');
                presetSelect.id = 'toneCurvePresetSelect';
                presetSelect.style.cssText = `
                    padding: 4px 8px;
                    background: #444;
                    border: 1px solid #555;
                    border-radius: 4px;
                    color: #fff;
                    font-size: 12px;
                `;
                presetSelect.innerHTML = `
                    <option value="Linear">Linear</option>
                    <option value="Medium Contrast">Medium Contrast</option>
                    <option value="Strong Contrast">Strong Contrast</option>
                    <option value="Custom">Custom</option>
                `;
                
                const saveBtn = document.createElement('button');
                saveBtn.style.cssText = `
                    padding: 4px 12px;
                    font-size: 12px;
                    background: #4a7c4e;
                    border: none;
                    border-radius: 4px;
                    color: #fff;
                    cursor: pointer;
                `;
                saveBtn.innerHTML = 'ğŸ’¾ ä¿å­˜';
                
                const closeBtn = document.createElement('button');
                closeBtn.style.cssText = `
                    background: #e25c5c;
                    border: none;
                    border-radius: 4px;
                    padding: 6px 12px;
                    color: white;
                    cursor: pointer;
                    font-size: 12px;
                `;
                closeBtn.textContent = 'âœ• å…³é—­';
                closeBtn.onclick = () => modal.remove();
                
                presetContainer.appendChild(presetSelect);
                presetContainer.appendChild(saveBtn);
                presetContainer.appendChild(closeBtn);
                
                header.appendChild(title);
                header.appendChild(presetContainer);
                content.appendChild(header);
                
                // åˆ›å»ºä¸»ä½“å†…å®¹
                const body = document.createElement('div');
                body.style.cssText = `
                    flex: 1;
                    display: flex;
                    overflow: hidden;
                `;
                
                // å·¦ä¾§é¢æ¿ - å›¾åƒé¢„è§ˆåŒºï¼ˆä¸PS Curveä¸€è‡´çš„æ¯”ä¾‹ï¼‰
                const leftPanel = document.createElement('div');
                leftPanel.style.cssText = `
                    flex: 1;
                    padding: 20px;
                    background: #2b2b2b;
                    border-right: 1px solid #333;
                    display: flex;
                    flex-direction: column;
                `;
                
                const previewTitle = document.createElement('h4');
                previewTitle.style.cssText = `
                    margin: 0 0 15px 0;
                    color: #aaa;
                    font-size: 14px;
                `;
                previewTitle.textContent = 'å›¾åƒé¢„è§ˆ';
                
                const previewContainer = document.createElement('div');
                previewContainer.style.cssText = `
                    flex: 1;
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    border: 1px solid #444;
                    border-radius: 4px;
                    background: #1a1a1a;
                `;
                
                const previewPlaceholder = document.createElement('div');
                previewPlaceholder.style.cssText = `
                    text-align: center;
                    color: #666;
                    font-size: 14px;
                `;
                previewPlaceholder.innerHTML = `
                    <div>ğŸ“¸</div>
                    <div>å›¾åƒé¢„è§ˆ</div>
                    <div style="font-size: 12px; margin-top: 5px;">è¿æ¥å›¾åƒåæ˜¾ç¤º</div>
                `;
                
                previewContainer.appendChild(previewPlaceholder);
                leftPanel.appendChild(previewTitle);
                leftPanel.appendChild(previewContainer);
                
                // å³ä¾§é¢æ¿ - æ›²çº¿ç¼–è¾‘å’Œæ§åˆ¶åŒºï¼ˆä¸PS Curveä¸€è‡´çš„æ¯”ä¾‹ï¼‰
                const rightPanel = document.createElement('div');
                rightPanel.style.cssText = `
                    width: 600px;
                    display: flex;
                    flex-direction: column;
                    background: #333;
                    overflow: hidden;
                `;
                
                // æ›²çº¿ç¼–è¾‘å™¨åŒºåŸŸ
                const curveSection = document.createElement('div');
                curveSection.style.cssText = `
                    flex: 1;
                    padding: 20px;
                    display: flex;
                    justify-content: center;
                    align-items: center;
                `;
                
                const canvas = document.createElement('canvas');
                canvas.id = 'toneCurveCanvas';
                canvas.width = 400;
                canvas.height = 400;
                canvas.style.cssText = `
                    border: 1px solid #444;
                    border-radius: 4px;
                    background: #1a1a1a;
                    cursor: crosshair;
                `;
                curveSection.appendChild(canvas);
                
                // æ§åˆ¶é¢æ¿åŒºåŸŸ
                const controlsSection = document.createElement('div');
                controlsSection.style.cssText = `
                    padding: 20px;
                    border-top: 1px solid #444;
                    max-height: 350px;
                    overflow-y: auto;
                `;
                
                controlsSection.innerHTML = `
                    <!-- æ›²çº¿æ¨¡å¼ -->
                    <div style="margin-bottom: 20px;">
                        <h4 style="margin: 0 0 10px 0; color: #aaa; font-size: 14px;">æ›²çº¿æ¨¡å¼</h4>
                        <div style="display: flex; gap: 5px;">
                            <button class="mode-btn" data-mode="Point" style="flex: 1; padding: 6px; font-size: 11px; background: #555; border: none; border-radius: 3px; color: #fff; cursor: pointer;">ç‚¹æ›²çº¿</button>
                            <button class="mode-btn" data-mode="Parametric" style="flex: 1; padding: 6px; font-size: 11px; background: #555; border: none; border-radius: 3px; color: #fff; cursor: pointer;">å‚æ•°</button>
                            <button class="mode-btn" data-mode="Combined" style="flex: 1; padding: 6px; font-size: 11px; background: #4a90e2; border: none; border-radius: 3px; color: #fff; cursor: pointer;">ç»„åˆ</button>
=======
                    background-color: #2b2b2b;
                    border-radius: 10px;
                    padding: 20px;
                    width: 800px;
                    max-width: 90vw;
                    max-height: 90vh;
                    overflow-y: auto;
                    color: white;
                    border: 2px solid #444;
                `;
                
                // åˆ›å»ºå†…å®¹
                content.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2 style="margin: 0; color: #fff;">ğŸ“ˆ Camera Raw è‰²è°ƒæ›²çº¿</h2>
                        <button id="closeToneCurve" style="background: #ff4757; border: none; border-radius: 5px; padding: 8px 15px; color: white; cursor: pointer;">âœ• å…³é—­</button>
                    </div>
                    
                    <!-- é¢„è®¾é€‰æ‹© -->
                    <div style="margin-bottom: 20px; padding: 15px; background: #3a3a3a; border-radius: 8px;">
                        <h3 style="margin-top: 0; color: #0ea5e9;">ğŸ“‹ æ›²çº¿é¢„è®¾</h3>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <button class="preset-btn" data-preset="Linear">Linear</button>
                            <button class="preset-btn" data-preset="Medium Contrast">Medium Contrast</button>
                            <button class="preset-btn" data-preset="Strong Contrast">Strong Contrast</button>
                            <button class="preset-btn" data-preset="Custom">Custom</button>
                        </div>
                    </div>
                    
                    <!-- æ›²çº¿æ¨¡å¼é€‰æ‹© -->
                    <div style="margin-bottom: 20px; padding: 15px; background: #3a3a3a; border-radius: 8px;">
                        <h3 style="margin-top: 0; color: #10b981;">ğŸ›ï¸ æ›²çº¿æ¨¡å¼</h3>
                        <div style="display: flex; gap: 10px;">
                            <button class="mode-btn" data-mode="Point">ç‚¹æ›²çº¿</button>
                            <button class="mode-btn" data-mode="Parametric">å‚æ•°æ›²çº¿</button>
                            <button class="mode-btn" data-mode="Combined">ç»„åˆæ¨¡å¼</button>
                        </div>
                    </div>
                    
                    <!-- æ›²çº¿ç¼–è¾‘å™¨ -->
                    <div style="margin-bottom: 20px; padding: 15px; background: #3a3a3a; border-radius: 8px;">
                        <h3 style="margin-top: 0; color: #f59e0b;">ğŸ“Š æ›²çº¿ç¼–è¾‘å™¨</h3>
                        <div style="display: flex; gap: 20px;">
                            <div style="flex: 1;">
                                <canvas id="toneCurveCanvas" width="400" height="400" style="border: 1px solid #666; border-radius: 5px; background: #1a1a1a; cursor: crosshair;"></canvas>
                            </div>
                            <div style="width: 200px;">
                                <div id="curvePreview" style="width: 200px; height: 200px; border: 1px solid #666; border-radius: 5px; background: #1a1a1a; margin-bottom: 10px;">
                                    <div style="padding: 20px; text-align: center; color: #888;">
                                        å›¾åƒé¢„è§ˆ
                                        <br><small>è¿æ¥å›¾åƒåæ˜¾ç¤º</small>
                                    </div>
                                </div>
                                <button id="resetCurve" style="width: 100%; background: #3b82f6; border: none; border-radius: 5px; padding: 8px; color: white; cursor: pointer;">é‡ç½®æ›²çº¿</button>
                            </div>
>>>>>>> 46f66396712d9c95a0a726341177cdf1f4149a5f
                        </div>
                    </div>
                    
                    <!-- å‚æ•°è°ƒæ•´ -->
<<<<<<< HEAD
                    <div style="margin-bottom: 20px;">
                        <h4 style="margin: 0 0 15px 0; color: #aaa; font-size: 14px;">å‚æ•°è°ƒæ•´</h4>
                        <div>
                            <div style="margin-bottom: 12px;">
                                <label style="display: block; margin-bottom: 4px; color: #ff6b6b; font-size: 12px;">é«˜å…‰ (Highlights)</label>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <input type="range" id="highlights" min="-100" max="100" value="0" style="flex: 1;">
                                    <span id="highlightsValue" style="color: #ccc; font-size: 11px; width: 30px;">0</span>
                                </div>
                            </div>
                            <div style="margin-bottom: 12px;">
                                <label style="display: block; margin-bottom: 4px; color: #fbbf24; font-size: 12px;">æ˜äº® (Lights)</label>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <input type="range" id="lights" min="-100" max="100" value="0" style="flex: 1;">
                                    <span id="lightsValue" style="color: #ccc; font-size: 11px; width: 30px;">0</span>
                                </div>
                            </div>
                            <div style="margin-bottom: 12px;">
                                <label style="display: block; margin-bottom: 4px; color: #60a5fa; font-size: 12px;">æš—éƒ¨ (Darks)</label>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <input type="range" id="darks" min="-100" max="100" value="0" style="flex: 1;">
                                    <span id="darksValue" style="color: #ccc; font-size: 11px; width: 30px;">0</span>
                                </div>
                            </div>
                            <div style="margin-bottom: 12px;">
                                <label style="display: block; margin-bottom: 4px; color: #4338ca; font-size: 12px;">é˜´å½± (Shadows)</label>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <input type="range" id="shadows" min="-100" max="100" value="0" style="flex: 1;">
                                    <span id="shadowsValue" style="color: #ccc; font-size: 11px; width: 30px;">0</span>
                                </div>
=======
                    <div style="margin-bottom: 20px; padding: 15px; background: #3a3a3a; border-radius: 8px;">
                        <h3 style="margin-top: 0; color: #8b5cf6;">ğŸšï¸ å‚æ•°è°ƒæ•´ (Parametric Curve)</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div>
                                <label style="display: block; margin-bottom: 5px; color: #ff6b6b;">é«˜å…‰ (Highlights)</label>
                                <input type="range" id="highlights" min="-100" max="100" value="0" style="width: 100%;">
                                <span id="highlightsValue" style="color: #ff6b6b; font-weight: bold;">0</span>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; color: #feca57;">æ˜äº® (Lights)</label>
                                <input type="range" id="lights" min="-100" max="100" value="0" style="width: 100%;">
                                <span id="lightsValue" style="color: #feca57; font-weight: bold;">0</span>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; color: #48cae4;">æš—éƒ¨ (Darks)</label>
                                <input type="range" id="darks" min="-100" max="100" value="0" style="width: 100%;">
                                <span id="darksValue" style="color: #48cae4; font-weight: bold;">0</span>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; color: #6c5ce7;">é˜´å½± (Shadows)</label>
                                <input type="range" id="shadows" min="-100" max="100" value="0" style="width: 100%;">
                                <span id="shadowsValue" style="color: #6c5ce7; font-weight: bold;">0</span>
>>>>>>> 46f66396712d9c95a0a726341177cdf1f4149a5f
                            </div>
                        </div>
                    </div>
                    
                    <!-- æ“ä½œæŒ‰é’® -->
<<<<<<< HEAD
                    <div style="display: flex; flex-direction: column; gap: 8px;">
                        <button id="resetCurve" style="width: 100%; background: #6b7280; border: none; border-radius: 4px; padding: 8px; color: white; cursor: pointer; font-size: 12px;">é‡ç½®æ›²çº¿</button>
                        <button id="resetAll" style="width: 100%; background: #dc2626; border: none; border-radius: 4px; padding: 8px; color: white; cursor: pointer; font-size: 12px;">é‡ç½®æ‰€æœ‰</button>
                    </div>
                `;
                
                rightPanel.appendChild(curveSection);
                rightPanel.appendChild(controlsSection);
                
                body.appendChild(leftPanel);
                body.appendChild(rightPanel);
                content.appendChild(body);
                
=======
                    <div style="display: flex; gap: 10px; justify-content: center;">
                        <button id="applyToneCurve" style="background: #27ae60; border: none; border-radius: 5px; padding: 12px 25px; color: white; cursor: pointer; font-weight: bold;">âœ… åº”ç”¨</button>
                        <button id="resetAllTone" style="background: #e74c3c; border: none; border-radius: 5px; padding: 12px 25px; color: white; cursor: pointer; font-weight: bold;">ğŸ”„ é‡ç½®å…¨éƒ¨</button>
                    </div>
                `;
                
>>>>>>> 46f66396712d9c95a0a726341177cdf1f4149a5f
                modal.appendChild(content);
                document.body.appendChild(modal);
                
                // åˆå§‹åŒ–æ›²çº¿ç¼–è¾‘å™¨
                this.initializeToneCurveEditor();
                
                // ç»‘å®šäº‹ä»¶
                this.bindToneCurveEvents();
<<<<<<< HEAD
            };
            
            // åˆå§‹åŒ–æ›²çº¿ç¼–è¾‘å™¨
            nodeType.prototype.initializeToneCurveEditor = function() {
                const canvas = document.getElementById('toneCurveCanvas');
                if (!canvas) return;
                
                const ctx = canvas.getContext('2d');
                this.toneCurvePoints = [[0, 0], [255, 255]];
                this.selectedPoint = -1;
                this.isDragging = false;
                
=======
                
                // åŠ è½½å½“å‰è®¾ç½®
                this.loadCurrentToneCurveSettings();
            };
            
            nodeType.prototype.initializeToneCurveEditor = function() {
                const canvas = document.getElementById('toneCurveCanvas');
                const ctx = canvas.getContext('2d');
                
                this.toneCurvePoints = [[0, 0], [255, 255]]; // å½“å‰æ›²çº¿ç‚¹
                this.selectedPoint = -1;
                this.isDragging = false;
                
                // ç»˜åˆ¶æ›²çº¿
                this.drawToneCurve();
                
>>>>>>> 46f66396712d9c95a0a726341177cdf1f4149a5f
                // ç»‘å®šé¼ æ ‡äº‹ä»¶
                canvas.addEventListener('mousedown', (e) => this.handleToneCurveMouseDown(e));
                canvas.addEventListener('mousemove', (e) => this.handleToneCurveMouseMove(e));
                canvas.addEventListener('mouseup', (e) => this.handleToneCurveMouseUp(e));
                canvas.addEventListener('dblclick', (e) => this.handleToneCurveDoubleClick(e));
<<<<<<< HEAD
                
                this.drawToneCurve();
            };
            
            // ç»˜åˆ¶æ›²çº¿
=======
            };
            
>>>>>>> 46f66396712d9c95a0a726341177cdf1f4149a5f
            nodeType.prototype.drawToneCurve = function() {
                const canvas = document.getElementById('toneCurveCanvas');
                if (!canvas) return;
                
                const ctx = canvas.getContext('2d');
                const width = canvas.width;
                const height = canvas.height;
                
                // æ¸…ç©ºç”»å¸ƒ
                ctx.fillStyle = '#1a1a1a';
                ctx.fillRect(0, 0, width, height);
                
<<<<<<< HEAD
                // ç»˜åˆ¶ç½‘æ ¼
=======
                // ç»˜åˆ¶PSé£æ ¼çš„ç½‘æ ¼
>>>>>>> 46f66396712d9c95a0a726341177cdf1f4149a5f
                ctx.strokeStyle = '#404040';
                ctx.lineWidth = 0.5;
                ctx.beginPath();
                
                // å‚ç›´çº¿
<<<<<<< HEAD
                for (let i = 0; i <= 4; i++) {
                    const x = (i * width) / 4;
=======
                for (let i = 0; i <= 8; i++) {
                    const x = (i / 8) * width;
>>>>>>> 46f66396712d9c95a0a726341177cdf1f4149a5f
                    ctx.moveTo(x, 0);
                    ctx.lineTo(x, height);
                }
                
<<<<<<< HEAD
                // æ°´å¹³çº¿
                for (let i = 0; i <= 4; i++) {
                    const y = (i * height) / 4;
=======
                // æ°´å¹³çº¿  
                for (let i = 0; i <= 8; i++) {
                    const y = (i / 8) * height;
>>>>>>> 46f66396712d9c95a0a726341177cdf1f4149a5f
                    ctx.moveTo(0, y);
                    ctx.lineTo(width, y);
                }
                ctx.stroke();
                
<<<<<<< HEAD
                // ç»˜åˆ¶å¯¹è§’çº¿
                ctx.strokeStyle = '#808080';
                ctx.lineWidth = 1;
                ctx.setLineDash([5, 5]);
=======
                // ç»˜åˆ¶PSé£æ ¼çš„å¯¹è§’çº¿ï¼ˆåŸå§‹è‰²è°ƒï¼‰
                ctx.strokeStyle = '#808080';
                ctx.lineWidth = 1;
                ctx.setLineDash([3, 3]); // PSé£æ ¼çš„è™šçº¿
>>>>>>> 46f66396712d9c95a0a726341177cdf1f4149a5f
                ctx.beginPath();
                ctx.moveTo(0, height);
                ctx.lineTo(width, 0);
                ctx.stroke();
                ctx.setLineDash([]);
                
<<<<<<< HEAD
                // ç»˜åˆ¶æ›²çº¿
                ctx.strokeStyle = '#ffffff';
                ctx.lineWidth = 1.5;
                ctx.beginPath();
                
                for (let x = 0; x < width; x++) {
                    const inputValue = (x / width) * 255;
                    const outputValue = this.interpolateCurve(inputValue);
=======
                // ç»˜åˆ¶åŒºåŸŸæ ‡è¯†
                const regions = [
                    { start: 0, end: 0.25, color: '#6c5ce7', label: 'é˜´å½±' },
                    { start: 0.25, end: 0.5, color: '#48cae4', label: 'æš—éƒ¨' },
                    { start: 0.5, end: 0.75, color: '#feca57', label: 'æ˜äº®' },
                    { start: 0.75, end: 1.0, color: '#ff6b6b', label: 'é«˜å…‰' }
                ];
                
                regions.forEach(region => {
                    const startX = region.start * width;
                    const endX = region.end * width;
                    
                    ctx.fillStyle = region.color + '08'; // éå¸¸æ·¡çš„åŒºåŸŸæ ‡è¯†ï¼Œç±»ä¼¼PS
                    ctx.fillRect(startX, 0, endX - startX, height);
                    
                    // ç»˜åˆ¶PSé£æ ¼çš„åŒºåŸŸæ ‡ç­¾
                    ctx.fillStyle = region.color + 'C0'; // åŠé€æ˜æ ‡ç­¾
                    ctx.font = '10px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText(region.label, (startX + endX) / 2, height - 8);
                });
                
                // ç”Ÿæˆæ›²çº¿
                const curvePoints = this.generateCurveFromPoints();
                
                // ç»˜åˆ¶PSé£æ ¼çš„ç²¾ç»†æ›²çº¿
                ctx.strokeStyle = '#ffffff';
                ctx.lineWidth = 1.5; // PSé£æ ¼çš„ç»†çº¿æ¡
                ctx.shadowBlur = 0; // ç§»é™¤é˜´å½±ï¼Œä¿æŒPSç®€æ´é£æ ¼
                ctx.beginPath();
                
                // ä½¿ç”¨é«˜å¯†åº¦é‡‡æ ·ç¡®ä¿æ›²çº¿å¹³æ»‘
                const step = 0.25; // æ›´ç»†è‡´çš„é‡‡æ ·
                for (let x = 0; x < width; x += step) {
                    const inputValue = (x / width) * 255;
                    const outputValue = this.interpolateCurve(inputValue, curvePoints);
>>>>>>> 46f66396712d9c95a0a726341177cdf1f4149a5f
                    const y = height - (outputValue / 255) * height;
                    
                    if (x === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                }
                ctx.stroke();
                
<<<<<<< HEAD
                // ç»˜åˆ¶æ§åˆ¶ç‚¹
                ctx.fillStyle = '#ffffff';
                ctx.strokeStyle = '#000000';
                ctx.lineWidth = 1;
                
=======
                // ç»˜åˆ¶PSé£æ ¼çš„æ§åˆ¶ç‚¹
>>>>>>> 46f66396712d9c95a0a726341177cdf1f4149a5f
                this.toneCurvePoints.forEach((point, index) => {
                    const x = (point[0] / 255) * width;
                    const y = height - (point[1] / 255) * height;
                    
<<<<<<< HEAD
                    ctx.beginPath();
                    ctx.arc(x, y, 3, 0, 2 * Math.PI);
                    ctx.fill();
                    ctx.stroke();
                });
            };
            
            // æ›²çº¿æ’å€¼ - ä½¿ç”¨å¹³æ»‘ä¸‰æ¬¡æ ·æ¡æ’å€¼ï¼ˆä¸PSé£æ ¼ä¸€è‡´ï¼‰
            nodeType.prototype.interpolateCurve = function(inputValue) {
                const points = this.toneCurvePoints;
                let baseValue;
                
                if (inputValue <= points[0][0]) {
                    baseValue = points[0][1];
                } else if (inputValue >= points[points.length - 1][0]) {
                    baseValue = points[points.length - 1][1];
                } else {
                    // ä½¿ç”¨Catmull-Romæ ·æ¡æ’å€¼åˆ›å»ºå¹³æ»‘æ›²çº¿
                    baseValue = this.catmullRomInterpolate(points, inputValue);
                }
                
                // åº”ç”¨å‚æ•°è°ƒæ•´ï¼ˆé«˜å…‰ã€æ˜äº®ã€æš—éƒ¨ã€é˜´å½±ï¼‰
                const parametricValue = this.applyParametricAdjustments(inputValue, baseValue);
                
                return Math.max(0, Math.min(255, parametricValue));
            };
            
            // åº”ç”¨å‚æ•°è°ƒæ•´ï¼ˆCamera Rawé£æ ¼ï¼‰
            nodeType.prototype.applyParametricAdjustments = function(inputValue, baseValue) {
                const { highlights, lights, darks, shadows } = this.toneCurveData;
                
                // å¦‚æœæ‰€æœ‰å‚æ•°éƒ½ä¸º0ï¼Œç›´æ¥è¿”å›åŸºç¡€å€¼
                if (highlights === 0 && lights === 0 && darks === 0 && shadows === 0) {
                    return baseValue;
                }
                
                // Camera Rawé£æ ¼çš„åŒºåŸŸå®šä¹‰
                // é˜´å½±: 0-63.75, æš—éƒ¨: 63.75-127.5, æ˜äº®: 127.5-191.25, é«˜å…‰: 191.25-255
                const shadowsEnd = 63.75;
                const darksEnd = 127.5;
                const lightsEnd = 191.25;
                
                // è®¡ç®—å„åŒºåŸŸçš„æƒé‡ï¼ˆä½¿ç”¨é«˜æ–¯å‡½æ•°åˆ›å»ºå¹³æ»‘è¿‡æ¸¡ï¼‰
                const shadowWeight = this.calculateRegionWeight(inputValue, 0, shadowsEnd);
                const darkWeight = this.calculateRegionWeight(inputValue, shadowsEnd, darksEnd);
                const lightWeight = this.calculateRegionWeight(inputValue, darksEnd, lightsEnd);
                const highlightWeight = this.calculateRegionWeight(inputValue, lightsEnd, 255);
                
                // è®¡ç®—æ€»çš„è°ƒæ•´é‡ï¼ˆCamera Rawé£æ ¼çš„æ•æ„Ÿåº¦ï¼‰
                const totalAdjustment = (
                    shadows * shadowWeight * 0.8 +      // é˜´å½±æ•æ„Ÿåº¦
                    darks * darkWeight * 0.6 +          // æš—éƒ¨æ•æ„Ÿåº¦
                    lights * lightWeight * 0.6 +        // æ˜äº®æ•æ„Ÿåº¦
                    highlights * highlightWeight * 0.8   // é«˜å…‰æ•æ„Ÿåº¦
                );
                
                // å°†è°ƒæ•´è½¬æ¢ä¸ºæ›²çº¿åç§»ï¼ˆCamera Rawæ ‡å‡†ç³»æ•°ï¼‰
                const curveOffset = totalAdjustment * 1.28;
                
                return baseValue + curveOffset;
            };
            
            // è®¡ç®—åŒºåŸŸæƒé‡ï¼ˆCamera Rawé£æ ¼çš„å¹³æ»‘æƒé‡å‡½æ•°ï¼‰
            nodeType.prototype.calculateRegionWeight = function(inputVal, regionStart, regionEnd) {
=======
                    // PSé£æ ¼çš„å°åœ†ç‚¹
                    const isSelected = index === this.selectedPoint;
                    const radius = isSelected ? 4 : 3;
                    
                    // å¤–åœˆï¼ˆé»‘è‰²è¾¹æ¡†ï¼‰
                    ctx.fillStyle = '#000000';
                    ctx.beginPath();
                    ctx.arc(x, y, radius + 1, 0, 2 * Math.PI);
                    ctx.fill();
                    
                    // å†…åœˆï¼ˆç™½è‰²å¡«å……ï¼‰
                    ctx.fillStyle = isSelected ? '#ffffff' : '#e0e0e0';
                    ctx.beginPath();
                    ctx.arc(x, y, radius, 0, 2 * Math.PI);
                    ctx.fill();
                });
            };
            
            nodeType.prototype.generateCurveFromPoints = function() {
                // åº”ç”¨å½“å‰é¢„è®¾å’Œå‚æ•°è°ƒæ•´
                const preset = this.toneCurveData.curve_preset;
                const highlights = this.toneCurveData.highlights;
                const lights = this.toneCurveData.lights;
                const darks = this.toneCurveData.darks;
                const shadows = this.toneCurveData.shadows;
                
                // ç”Ÿæˆ256ç‚¹çš„æ›²çº¿
                const curve = [];
                for (let i = 0; i < 256; i++) {
                    let output = i; // åŸºç¡€çº¿æ€§æ›²çº¿
                    
                    // åº”ç”¨é¢„è®¾æ›²çº¿
                    if (preset !== 'Linear') {
                        output = this.applyPresetCurve(i, preset);
                    }
                    
                    // åº”ç”¨å‚æ•°è°ƒæ•´
                    const inputVal = i / 255.0;
                    
                    // Camera Rawé£æ ¼çš„åŒºåŸŸæƒé‡
                    const shadowWeight = this.cameraRawRegionWeight(inputVal, 0.0, 0.25);
                    const darkWeight = this.cameraRawRegionWeight(inputVal, 0.25, 0.50);
                    const lightWeight = this.cameraRawRegionWeight(inputVal, 0.50, 0.75);
                    const highlightWeight = this.cameraRawRegionWeight(inputVal, 0.75, 1.0);
                    
                    const totalAdjustment = (
                        shadows * shadowWeight * 0.8 +
                        darks * darkWeight * 0.6 +
                        lights * lightWeight * 0.6 +
                        highlights * highlightWeight * 0.8
                    );
                    
                    const curveOffset = totalAdjustment * 1.28;
                    output = Math.min(255, Math.max(0, output + curveOffset));
                    
                    // åº”ç”¨ç‚¹æ›²çº¿
                    if (this.toneCurvePoints.length > 2) {
                        output = this.interpolateCurve(output, this.toneCurvePoints);
                    }
                    
                    curve.push(output);
                }
                
                return curve;
            };
            
            nodeType.prototype.cameraRawRegionWeight = function(inputVal, regionStart, regionEnd) {
>>>>>>> 46f66396712d9c95a0a726341177cdf1f4149a5f
                if (inputVal < regionStart || inputVal > regionEnd) {
                    return 0.0;
                }
                
                const regionCenter = (regionStart + regionEnd) / 2;
                const regionWidth = regionEnd - regionStart;
<<<<<<< HEAD
                
                // ä½¿ç”¨é«˜æ–¯å‡½æ•°åˆ›å»ºå¹³æ»‘çš„æƒé‡åˆ†å¸ƒ
                const distanceFromCenter = Math.abs(inputVal - regionCenter) / (regionWidth / 2);
                const weight = Math.exp(-2 * distanceFromCenter * distanceFromCenter);
                
                return weight;
            };
            
            // Catmull-Romæ ·æ¡æ’å€¼å®ç°
            nodeType.prototype.catmullRomInterpolate = function(points, x) {
                const n = points.length;
                
                // æ‰¾åˆ°xæ‰€åœ¨çš„åŒºé—´
                let i = 0;
                for (i = 0; i < n - 1; i++) {
                    if (x >= points[i][0] && x <= points[i + 1][0]) {
                        break;
                    }
                }
                
                // å¦‚æœåªæœ‰ä¸¤ä¸ªç‚¹ï¼Œä½¿ç”¨çº¿æ€§æ’å€¼
                if (n === 2) {
                    const t = (x - points[0][0]) / (points[1][0] - points[0][0]);
                    return points[0][1] + t * (points[1][1] - points[0][1]);
                }
                
                // è·å–å››ä¸ªæ§åˆ¶ç‚¹
                let p0, p1, p2, p3;
                
                if (i === 0) {
                    // èµ·å§‹åŒºé—´ï¼Œåˆ›å»ºè™šæ‹Ÿå‰ä¸€ä¸ªç‚¹
                    p0 = [points[0][0] - (points[1][0] - points[0][0]), points[0][1]];
                    p1 = points[0];
                    p2 = points[1];
                    p3 = points[2] || points[1];
                } else if (i === n - 2) {
                    // æœ«å°¾åŒºé—´ï¼Œåˆ›å»ºè™šæ‹Ÿåä¸€ä¸ªç‚¹
                    p0 = points[i - 1];
                    p1 = points[i];
                    p2 = points[i + 1];
                    p3 = [points[i + 1][0] + (points[i + 1][0] - points[i][0]), points[i + 1][1]];
                } else {
                    // ä¸­é—´åŒºé—´
                    p0 = points[i - 1];
                    p1 = points[i];
                    p2 = points[i + 1];
                    p3 = points[i + 2];
                }
                
                // å½’ä¸€åŒ–å‚æ•°t
                const t = (x - p1[0]) / (p2[0] - p1[0]);
                
                // Catmull-Romå…¬å¼ï¼ˆå¼ åŠ›ç³»æ•°0.3ï¼ŒåŒ¹é…PSé£æ ¼ï¼‰
                const tension = 0.3;
                const t2 = t * t;
                const t3 = t2 * t;
                
                // Catmull-RomåŸºå‡½æ•°
                const h00 = 2 * t3 - 3 * t2 + 1;
                const h10 = t3 - 2 * t2 + t;
                const h01 = -2 * t3 + 3 * t2;
                const h11 = t3 - t2;
                
                // è®¡ç®—åˆ‡çº¿ï¼ˆè€ƒè™‘å¼ åŠ›ï¼‰
                const m0 = tension * (p2[1] - p0[1]) / (p2[0] - p0[0]) * (p2[0] - p1[0]);
                const m1 = tension * (p3[1] - p1[1]) / (p3[0] - p1[0]) * (p2[0] - p1[0]);
                
                // æœ€ç»ˆæ’å€¼ç»“æœ
                const result = h00 * p1[1] + h10 * m0 + h01 * p2[1] + h11 * m1;
                
                return Math.max(0, Math.min(255, result));
=======
                const distanceFromCenter = Math.abs(inputVal - regionCenter) / (regionWidth / 2);
                
                return Math.exp(-2 * distanceFromCenter * distanceFromCenter);
            };
            
            nodeType.prototype.applyPresetCurve = function(input, preset) {
                const presets = {
                    'Medium Contrast': [
                        [0, 0], [32, 22], [64, 56], [128, 128], 
                        [192, 196], [224, 230], [255, 255]
                    ],
                    'Strong Contrast': [
                        [0, 0], [32, 16], [64, 44], [128, 128], 
                        [192, 208], [224, 240], [255, 255]
                    ]
                };
                
                const presetPoints = presets[preset];
                if (!presetPoints) return input;
                
                return this.interpolateCurve(input, presetPoints);
            };
            
            nodeType.prototype.interpolateCurve = function(x, points) {
                if (points.length < 2) return x;
                
                // ä½¿ç”¨å¹³æ»‘æ’å€¼ï¼ˆä¸‰æ¬¡æ ·æ¡æˆ–æ”¹è¿›çš„çº¿æ€§æ’å€¼ï¼‰
                if (points.length >= 3) {
                    return this.cubicSplineInterpolate(x, points);
                } else {
                    // ç‚¹æ•°ä¸è¶³æ—¶ä½¿ç”¨çº¿æ€§æ’å€¼
                    return this.linearInterpolate(x, points);
                }
            };
            
            nodeType.prototype.linearInterpolate = function(x, points) {
                for (let i = 0; i < points.length - 1; i++) {
                    const p1 = points[i];
                    const p2 = points[i + 1];
                    
                    if (x >= p1[0] && x <= p2[0]) {
                        if (p2[0] === p1[0]) return p1[1];
                        
                        const t = (x - p1[0]) / (p2[0] - p1[0]);
                        return p1[1] + t * (p2[1] - p1[1]);
                    }
                }
                
                if (x < points[0][0]) return points[0][1];
                if (x > points[points.length - 1][0]) return points[points.length - 1][1];
                
                return x;
            };
            
            nodeType.prototype.cubicSplineInterpolate = function(x, points) {
                // PSé£æ ¼çš„æ ·æ¡æ’å€¼ - è°ƒæ•´æ›²ç‡ä»¥åŒ¹é…PS
                const n = points.length;
                if (n < 3) return this.linearInterpolate(x, points);
                
                // æ‰¾åˆ°xæ‰€åœ¨çš„åŒºé—´
                let i = 0;
                while (i < n - 1 && x > points[i + 1][0]) {
                    i++;
                }
                
                if (i >= n - 1) return points[n - 1][1];
                if (i <= 0) return points[0][1];
                
                // è·å–å››ä¸ªæ§åˆ¶ç‚¹
                const p0 = i > 0 ? points[i - 1] : points[i];
                const p1 = points[i];
                const p2 = points[i + 1];
                const p3 = i < n - 2 ? points[i + 2] : points[i + 1];
                
                // è®¡ç®—å‚æ•°t (0åˆ°1ä¹‹é—´)
                const t = (x - p1[0]) / (p2[0] - p1[0]);
                const t2 = t * t;
                const t3 = t2 * t;
                
                // è°ƒæ•´æ›²ç‡ç³»æ•°ä»¥åŒ¹é…PSçš„æ›²çº¿ç‰¹æ€§
                const tension = 0.3; // PSé£æ ¼çš„å¼ åŠ›ç³»æ•°
                const y = 0.5 * (
                    (2 * p1[1]) +
                    (-p0[1] + p2[1]) * t * tension +
                    (2 * p0[1] - 5 * p1[1] + 4 * p2[1] - p3[1]) * t2 * (1 - tension) +
                    (-p0[1] + 3 * p1[1] - 3 * p2[1] + p3[1]) * t3 * tension
                );
                
                return Math.max(0, Math.min(255, y));
            };
            
            nodeType.prototype.bindToneCurveEvents = function() {
                // é¢„è®¾æŒ‰é’®
                document.querySelectorAll('.preset-btn').forEach(btn => {
                    btn.style.cssText = `
                        background: #444; border: none; border-radius: 5px; 
                        padding: 8px 15px; color: white; cursor: pointer; 
                        transition: background 0.3s;
                    `;
                    
                    btn.addEventListener('click', () => {
                        document.querySelectorAll('.preset-btn').forEach(b => b.style.background = '#444');
                        btn.style.background = '#0ea5e9';
                        
                        this.toneCurveData.curve_preset = btn.dataset.preset;
                        this.drawToneCurve();
                    });
                });
                
                // æ¨¡å¼æŒ‰é’®
                document.querySelectorAll('.mode-btn').forEach(btn => {
                    btn.style.cssText = `
                        background: #444; border: none; border-radius: 5px; 
                        padding: 8px 15px; color: white; cursor: pointer; 
                        transition: background 0.3s;
                    `;
                    
                    btn.addEventListener('click', () => {
                        document.querySelectorAll('.mode-btn').forEach(b => b.style.background = '#444');
                        btn.style.background = '#10b981';
                        
                        this.toneCurveData.curve_mode = btn.dataset.mode;
                        this.drawToneCurve();
                    });
                });
                
                // å‚æ•°æ»‘å—
                ['highlights', 'lights', 'darks', 'shadows'].forEach(param => {
                    const slider = document.getElementById(param);
                    const valueSpan = document.getElementById(param + 'Value');
                    
                    slider.addEventListener('input', (e) => {
                        const value = parseFloat(e.target.value);
                        this.toneCurveData[param] = value;
                        valueSpan.textContent = value;
                        this.drawToneCurve();
                    });
                });
                
                // å…³é—­æŒ‰é’®
                document.getElementById('closeToneCurve').addEventListener('click', () => {
                    document.getElementById('toneCurveModal').remove();
                });
                
                // åº”ç”¨æŒ‰é’®
                document.getElementById('applyToneCurve').addEventListener('click', () => {
                    this.applyToneCurveSettings();
                });
                
                // é‡ç½®æŒ‰é’®
                document.getElementById('resetAllTone').addEventListener('click', () => {
                    this.resetToneCurveSettings();
                });
                
                // é‡ç½®æ›²çº¿æŒ‰é’®
                document.getElementById('resetCurve').addEventListener('click', () => {
                    this.toneCurvePoints = [[0, 0], [255, 255]];
                    this.drawToneCurve();
                });
                
                // ç‚¹å‡»èƒŒæ™¯å…³é—­
                document.getElementById('toneCurveModal').addEventListener('click', (e) => {
                    if (e.target.id === 'toneCurveModal') {
                        document.getElementById('toneCurveModal').remove();
                    }
                });
            };
            
            nodeType.prototype.loadCurrentToneCurveSettings = function() {
                // åŠ è½½å½“å‰èŠ‚ç‚¹è®¾ç½®åˆ°å¼¹çª—
                const widgets = this.widgets || [];
                
                widgets.forEach(widget => {
                    if (widget.name === 'curve_preset') {
                        this.toneCurveData.curve_preset = widget.value;
                        document.querySelector(`[data-preset="${widget.value}"]`)?.click();
                    } else if (widget.name === 'curve_mode') {
                        this.toneCurveData.curve_mode = widget.value;
                        document.querySelector(`[data-mode="${widget.value}"]`)?.click();
                    } else if (['highlights', 'lights', 'darks', 'shadows'].includes(widget.name)) {
                        this.toneCurveData[widget.name] = widget.value;
                        const slider = document.getElementById(widget.name);
                        const valueSpan = document.getElementById(widget.name + 'Value');
                        if (slider && valueSpan) {
                            slider.value = widget.value;
                            valueSpan.textContent = widget.value;
                        }
                    } else if (widget.name === 'point_curve') {
                        try {
                            this.toneCurvePoints = JSON.parse(widget.value);
                        } catch (e) {
                            this.toneCurvePoints = [[0, 0], [255, 255]];
                        }
                    }
                });
                
                this.drawToneCurve();
            };
            
            nodeType.prototype.applyToneCurveSettings = function() {
                // å°†å¼¹çª—è®¾ç½®åº”ç”¨åˆ°èŠ‚ç‚¹
                const widgets = this.widgets || [];
                
                // æ›´æ–°ç‚¹æ›²çº¿
                this.toneCurveData.point_curve = JSON.stringify(this.toneCurvePoints);
                
                widgets.forEach(widget => {
                    if (this.toneCurveData.hasOwnProperty(widget.name)) {
                        widget.value = this.toneCurveData[widget.name];
                    }
                });
                
                // è§¦å‘èŠ‚ç‚¹æ›´æ–°
                if (this.onWidgetChanged) {
                    this.onWidgetChanged('point_curve', this.toneCurveData.point_curve);
                }
                
                // å…³é—­å¼¹çª—
                document.getElementById('toneCurveModal').remove();
                
                console.log('è‰²è°ƒæ›²çº¿è®¾ç½®å·²åº”ç”¨:', this.toneCurveData);
            };
            
            nodeType.prototype.resetToneCurveSettings = function() {
                // é‡ç½®æ‰€æœ‰è®¾ç½®
                this.toneCurveData = {
                    curve_preset: 'Linear',
                    point_curve: '[[0,0],[255,255]]',
                    highlights: 0.0,
                    lights: 0.0,
                    darks: 0.0,
                    shadows: 0.0,
                    curve_mode: 'Combined'
                };
                
                this.toneCurvePoints = [[0, 0], [255, 255]];
                
                // æ›´æ–°ç•Œé¢
                document.querySelector('[data-preset="Linear"]')?.click();
                document.querySelector('[data-mode="Combined"]')?.click();
                
                ['highlights', 'lights', 'darks', 'shadows'].forEach(param => {
                    const slider = document.getElementById(param);
                    const valueSpan = document.getElementById(param + 'Value');
                    if (slider && valueSpan) {
                        slider.value = 0;
                        valueSpan.textContent = '0';
                    }
                });
                
                this.drawToneCurve();
>>>>>>> 46f66396712d9c95a0a726341177cdf1f4149a5f
            };
            
            // é¼ æ ‡äº‹ä»¶å¤„ç†
            nodeType.prototype.handleToneCurveMouseDown = function(e) {
                const canvas = document.getElementById('toneCurveCanvas');
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
<<<<<<< HEAD
                this.isDragging = true;
                this.selectedPoint = -1;
                
                // æ£€æŸ¥æ˜¯å¦ç‚¹å‡»äº†ç°æœ‰æ§åˆ¶ç‚¹
=======
                // æ£€æŸ¥æ˜¯å¦ç‚¹å‡»äº†ç°æœ‰æ§åˆ¶ç‚¹
                this.selectedPoint = -1;
>>>>>>> 46f66396712d9c95a0a726341177cdf1f4149a5f
                this.toneCurvePoints.forEach((point, index) => {
                    const px = (point[0] / 255) * canvas.width;
                    const py = canvas.height - (point[1] / 255) * canvas.height;
                    
                    const distance = Math.sqrt((x - px) ** 2 + (y - py) ** 2);
                    if (distance < 10) {
                        this.selectedPoint = index;
<<<<<<< HEAD
                    }
                });
                
                // å¦‚æœæ²¡æœ‰ç‚¹å‡»ç°æœ‰ç‚¹ï¼Œæ·»åŠ æ–°ç‚¹
                if (this.selectedPoint === -1) {
=======
                        this.isDragging = true;
                    }
                });
                
                if (this.selectedPoint === -1) {
                    // æ·»åŠ æ–°æ§åˆ¶ç‚¹ï¼ˆæ’é™¤èµ·ç‚¹å’Œç»ˆç‚¹ï¼‰
>>>>>>> 46f66396712d9c95a0a726341177cdf1f4149a5f
                    const newX = Math.round((x / canvas.width) * 255);
                    const newY = Math.round(((canvas.height - y) / canvas.height) * 255);
                    
                    if (newX > 0 && newX < 255) {
                        this.toneCurvePoints.push([newX, newY]);
                        this.toneCurvePoints.sort((a, b) => a[0] - b[0]);
                        this.selectedPoint = this.toneCurvePoints.findIndex(p => p[0] === newX && p[1] === newY);
<<<<<<< HEAD
                        this.drawToneCurve();
                    }
                }
=======
                        this.isDragging = true;
                    }
                }
                
                this.drawToneCurve();
>>>>>>> 46f66396712d9c95a0a726341177cdf1f4149a5f
            };
            
            nodeType.prototype.handleToneCurveMouseMove = function(e) {
                if (!this.isDragging || this.selectedPoint === -1) return;
                
                const canvas = document.getElementById('toneCurveCanvas');
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                const newX = Math.round((x / canvas.width) * 255);
                const newY = Math.round(((canvas.height - y) / canvas.height) * 255);
                
<<<<<<< HEAD
                // é™åˆ¶èŒƒå›´å’Œé˜²æ­¢äº¤å‰
                if (this.selectedPoint > 0 && this.selectedPoint < this.toneCurvePoints.length - 1) {
                    const prevX = this.toneCurvePoints[this.selectedPoint - 1][0];
                    const nextX = this.toneCurvePoints[this.selectedPoint + 1][0];
                    
                    this.toneCurvePoints[this.selectedPoint][0] = Math.max(prevX + 1, Math.min(nextX - 1, newX));
                    this.toneCurvePoints[this.selectedPoint][1] = Math.max(0, Math.min(255, newY));
                } else {
                    // ç«¯ç‚¹åªèƒ½è°ƒæ•´Yå€¼
                    this.toneCurvePoints[this.selectedPoint][1] = Math.max(0, Math.min(255, newY));
=======
                // é™åˆ¶èŒƒå›´
                const clampedX = Math.max(0, Math.min(255, newX));
                const clampedY = Math.max(0, Math.min(255, newY));
                
                // é˜²æ­¢èµ·ç‚¹å’Œç»ˆç‚¹ç§»åŠ¨
                if (this.selectedPoint === 0) {
                    this.toneCurvePoints[0] = [0, clampedY];
                } else if (this.selectedPoint === this.toneCurvePoints.length - 1) {
                    this.toneCurvePoints[this.selectedPoint] = [255, clampedY];
                } else {
                    this.toneCurvePoints[this.selectedPoint] = [clampedX, clampedY];
>>>>>>> 46f66396712d9c95a0a726341177cdf1f4149a5f
                }
                
                this.drawToneCurve();
            };
            
            nodeType.prototype.handleToneCurveMouseUp = function(e) {
                this.isDragging = false;
            };
            
            nodeType.prototype.handleToneCurveDoubleClick = function(e) {
<<<<<<< HEAD
=======
                // åŒå‡»åˆ é™¤æ§åˆ¶ç‚¹ï¼ˆé™¤äº†èµ·ç‚¹å’Œç»ˆç‚¹ï¼‰
>>>>>>> 46f66396712d9c95a0a726341177cdf1f4149a5f
                if (this.selectedPoint > 0 && this.selectedPoint < this.toneCurvePoints.length - 1) {
                    this.toneCurvePoints.splice(this.selectedPoint, 1);
                    this.selectedPoint = -1;
                    this.drawToneCurve();
                }
            };
<<<<<<< HEAD
            
            // ç»‘å®šäº‹ä»¶
            nodeType.prototype.bindToneCurveEvents = function() {
                // å‚æ•°æ»‘å—äº‹ä»¶
                ['highlights', 'lights', 'darks', 'shadows'].forEach(param => {
                    const slider = document.getElementById(param);
                    const valueSpan = document.getElementById(param + 'Value');
                    
                    if (slider && valueSpan) {
                        slider.addEventListener('input', (e) => {
                            const value = parseFloat(e.target.value);
                            valueSpan.textContent = value;
                            this.toneCurveData[param] = value;
                            this.drawToneCurve();
                        });
                    }
                });
                
                // æ¨¡å¼æŒ‰é’®äº‹ä»¶
                document.querySelectorAll('.mode-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const mode = e.target.dataset.mode;
                        this.toneCurveData.curve_mode = mode;
                        
                        // æ›´æ–°æŒ‰é’®çŠ¶æ€
                        document.querySelectorAll('.mode-btn').forEach(b => {
                            b.style.background = b === e.target ? '#4a90e2' : '#555';
                        });
                    });
                });
                
                // é‡ç½®æŒ‰é’®
                const resetCurve = document.getElementById('resetCurve');
                if (resetCurve) {
                    resetCurve.addEventListener('click', () => {
                        this.toneCurvePoints = [[0, 0], [255, 255]];
                        this.drawToneCurve();
                    });
                }
                
                const resetAll = document.getElementById('resetAll');
                if (resetAll) {
                    resetAll.addEventListener('click', () => {
                        this.toneCurveData = {
                            curve_preset: 'Linear',
                            point_curve: '[[0,0],[255,255]]',
                            highlights: 0.0,
                            lights: 0.0,
                            darks: 0.0,
                            shadows: 0.0,
                            curve_mode: 'Combined'
                        };
                        this.toneCurvePoints = [[0, 0], [255, 255]];
                        this.updateToneCurveInterface();
                        this.drawToneCurve();
                    });
                }
            };
            
            // é¢„è®¾ç³»ç»Ÿæ–¹æ³•
            nodeType.prototype.updateToneCurveInterface = function() {
                const highlights = document.getElementById('highlights');
                const lights = document.getElementById('lights');
                const darks = document.getElementById('darks');
                const shadows = document.getElementById('shadows');
                
                if (highlights) {
                    highlights.value = this.toneCurveData.highlights;
                    document.getElementById('highlightsValue').textContent = this.toneCurveData.highlights;
                }
                if (lights) {
                    lights.value = this.toneCurveData.lights;
                    document.getElementById('lightsValue').textContent = this.toneCurveData.lights;
                }
                if (darks) {
                    darks.value = this.toneCurveData.darks;
                    document.getElementById('darksValue').textContent = this.toneCurveData.darks;
                }
                if (shadows) {
                    shadows.value = this.toneCurveData.shadows;
                    document.getElementById('shadowsValue').textContent = this.toneCurveData.shadows;
                }
                
                // æ›´æ–°æ›²çº¿æ¨¡å¼æŒ‰é’®
                const modeButtons = document.querySelectorAll('.mode-btn');
                modeButtons.forEach(btn => {
                    btn.style.background = btn.dataset.mode === this.toneCurveData.curve_mode ? '#4a90e2' : '#555';
                });
            };
=======
>>>>>>> 46f66396712d9c95a0a726341177cdf1f4149a5f
        }
    }
});